/*
 * jQuery Background video plugin for jQuery
 * ---
 * Copyright 2011, Victor Coulon (http://victorcoulon.fr)
 * Released under the MIT, BSD, and GPL Licenses.
 * based on jQuery Plugin Boilerplate 1.3
 */

(function ($) {

    $.backgroundVideo = function (el, options) {

        var defaults = {
            videoid: "video_background"
        }

        var plugin = this;

        plugin.Settings = {}

        var init = function () {
            plugin.Settings = $.extend({}, defaults, options);
            plugin.el = el;

            buildVideo();
        }

        var buildVideo = function () {
            var html = '';
            html += '<video id="' + plugin.Settings.videoid + '" preload="auto" autoplay="autoplay" loop="loop"';

            if (plugin.Settings.poster) {
                html += ' poster="' + plugin.Settings.poster + '" ';
            }

            html += 'style="display:none;position:fixed;top:0;left:0;bottom:0;right:0;z-index:-100;width:100%;height:100%;">';
            for (var i = 0; i < plugin.Settings.types.length; i++) {
                html += '<source src="' + plugin.Settings.path + plugin.Settings.filename + '.' + plugin.Settings.types[i] + '" type="video/' + plugin.Settings.types[i] + '" />';
            }
            html += 'bgvideo</video>';
            plugin.el.prepend(html);
            plugin.videoEl = document.getElementById(plugin.Settings.videoid);
            plugin.$videoEl = $(plugin.videoEl);
            plugin.$videoEl.fadeIn(2000);
            setProportion();
        }

        var setProportion = function () {
            var proportion = getProportion();
            plugin.$videoEl.width(proportion * plugin.Settings.width);
            plugin.$videoEl.height(proportion * plugin.Settings.height);

            if (typeof plugin.Settings.align !== 'undefined') {
                centerVideo();
            }
        }

        var getProportion = function () {
            var windowWidth = $(plugin.Settings.holder).width();
            var windowHeight = $(plugin.Settings.holder).height();
            var windowProportion = windowWidth / windowHeight;
            var origProportion = plugin.Settings.width / plugin.Settings.height;
            var proportion = windowHeight / plugin.Settings.height;

            if (windowProportion >= origProportion) {
                proportion = windowWidth / plugin.Settings.width;
            }

            return proportion;
        }

        var centerVideo = function () {
            var centerX = (($(plugin.Settings.holder).width() >> 1) - (plugin.$videoEl.width() >> 1)) | 0;
            var centerY = (($(plugin.Settings.holder).height() >> 1) - (plugin.$videoEl.height() >> 1)) | 0;

            if (plugin.Settings.align == 'centerXY') {
                plugin.$videoEl.css({ 'left': centerX, 'top': centerY });
                return;
            }

            if (plugin.Settings.align == 'centerX') {
                plugin.$videoEl.css('left', centerX);
                return;
            }

            if (plugin.Settings.align == 'centerY') {
                plugin.$videoEl.css('top', centerY);
                return;
            }
        }

        init();

        $(window).resize(function () {
            setProportion();
        });
        plugin.$videoEl.bind('ended', function () {
            this.play();
        });
    }
})(jQuery);